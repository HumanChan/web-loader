# 网页资源导出桌面应用 分阶段开发计划
版本：v1.0  
日期：2025-08-13  
参照需求：docs/需求文档.md

## 0. 背景与目标
构建一款基于 Electron 的桌面应用，用于访问目标网页并将会话期间加载的 H5 常见资源全量导出至本地目录。满足固定布局：窗口 1080×1380、左侧网页显示区固定 720×1280、右侧控制面板约 360 宽；提供资源列表、过滤/搜索、域名与类型筛选、暂停/继续/停止、导出进度与失败项提示；设置持久化。

不在本期范围：认证登录、WASM/HLS/DASH 分片、`blob:`/`data:` 等内存态资源的完整导出保证。

## 1. 架构总览
- 技术栈
  - 桌面：Electron + TypeScript
  - 渲染：React + Vite（虚拟列表使用 react-window）
  - 持久化：electron-store
  - 文件与工具：fs-extra、mime-types（或自定义映射）、nanoid
- 关键设计
  - 网页显示：渲染端 `<webview>`（独立 partition，会话级隔离）
  - 资源捕获：主进程使用 `session.protocol.interceptStreamProtocol('http'/'https')` 捕获响应体并实时落盘；同时用 `session.webRequest` 补充类型/头/时序与错误。注：需求文档中的“基于 webRequest 的拦截”在实现层细化为“interceptStreamProtocol + webRequest”组合以满足“实时落盘”的能力。
  - 导出策略：实时落盘到会话临时目录 + 索引；导出时按规则汇总复制到目标目录

## 2. 窗口与布局
- 窗口：1080×1380（可水平拉伸，最小右栏宽 360；纵向固定保障 720×1280 内容区）
- 左上 URL 输入区：720×100（输入框 + “确定”）
- 左侧网页显示区：720×1280（固定像素，不随缩放变形）
- 右侧控制面板：360×全高（导出/路径、控制、筛选/搜索、资源列表、统计与进度）

## 3. 模块划分
- 主进程
  - 窗口/会话：`src/main/main.ts`、`preload.ts`
  - IPC：`src/main/ipc/IpcChannels.ts`、`MainIpcHandlers.ts`
  - 捕获：`src/main/capture/ResourceCaptureService.ts`、`UrlNormalizer.ts`
  - 导出：`src/main/export/ExportService.ts`
  - 设置：`src/main/store/SettingsStore.ts`
  - 工具：`PathUtils.ts`、`MimeUtils.ts`、`Logger.ts`
- 渲染进程
  - 布局：`App.tsx`、`UrlBar.tsx`、`WebPane.tsx`、`SidePanel.tsx`
  - 控件：`Controls.tsx`（确定/暂停/继续/停止/导出）
  - 筛选：`FilterBar.tsx`（类型/域名/关键词）
  - 列表：`ResourceList.tsx`（react-window）
  - 统计：`StatsBar.tsx`
  - 状态：`useUiStore.ts`
  - IPC 封装：`rendererIpc.ts`
- 共享类型：`src/shared/types.ts`

## 4. 核心数据结构（摘要）
- `ResourceType`: `"document" | "stylesheet" | "script" | "image" | "font" | "audio" | "xhr" | "fetch" | "json" | "other"`
- `NormalizedUrl`: `originalUrl`, `normalizedUrl`, `host`, `pathname`, `queryHashSuffix?`, `relativePathFromRoot`
- `ResourceRecord`: `id`, `type`, `url`, `normalized`, `method`, `statusCode?`, `mimeType?`, `contentLength?`, `sizeOnDisk?`, `startedAt`, `finishedAt?`, `state`, `referrer?`, `errorMessage?`, `tempFilePath?`, `finalFilePath?`, `originHost`
- `CaptureSession`: `sessionId`, `partition`, `startedAt`, `state`, `tempDir`
- `ExportProgress`: `total`, `completed`, `failed`, `bytesTotal`, `bytesCompleted`

## 5. 关键接口（摘要）
- `UrlNormalizer.normalizeUrl(url, mainDocumentUrl) -> NormalizedUrl`
- `ResourceCaptureService.start/pause/resume/stop/getRecords`
- `ExportService.exportAll(records, onProgress) -> Promise<void>`
- `SettingsStore.get/set`
- IPC 通道：`capture:start/pause/resume/stop`、`webview:navigate`、`export:run`、`settings:get/set`、`records:subscribe`

## 6. 工作流
1) 渲染端点击“确定”→ IPC 通知主进程创建新会话（partition/tempDir），绑定拦截器  
2) `<webview>` 导航到 URL，计时器开始  
3) `interceptStreamProtocol` 捕获响应体并实时写入临时目录，`webRequest` 记录类型/头/时序/错误  
4) 资源列表实时更新（节流 200–500ms），支持筛选/搜索/排序  
5) 暂停：冻结新写盘（在流中的继续至完成）；继续：恢复；停止：移除监听，冻结会话  
6) 导出：按目录规则复制临时文件到目标目录，显示进度；完成后重置计时器与会话

## 7. 目录与命名规则
- 根目录：主文档 HTML 所在目录
- 主域：按原始 URL 路径层级落盘
- 第三方域：`external/<host>/...`
- 查询串：对规范化后的查询计算短哈希，追加到扩展名前，如：`/assets/main.__q_ab12cd34.js`
- 片段（#...）不参与归一化
- 去重：仅以 URL 归一化为准

## 8. 错误处理策略
- 网络/写盘错误：记录 `errorMessage`，失败不阻断；写盘重试 2 次（200ms/800ms 退避）
- 命名冲突：理论避免，若发生追加 `__n` 后缀
- 超大文件：阈值提示，可中止导出
- 异常退出：可选“启动清理上次临时文件”或恢复提示

## 9. 持久化
- 项：导出路径、默认过滤/排序、窗口与分栏尺寸、并发与节流、启动清理临时目录
- 工具：electron-store（支持未来迁移）

## 10. 性能与稳定性
- 并发与限流：建议 4–8 并发写盘
- UI 节流：200–500ms
- 大列表：react-window 虚拟列表
- 导出与捕获互不阻塞 UI

## 11. 依赖建议
- electron、typescript、@types/node、vite、react、react-dom
- electron-store、fs-extra、react-window、mime-types、nanoid

## 12. 测试计划
- 单元：UrlNormalizer、路径与哈希规则、边界 URL
- 集成：本地静态资源站点（HTML/CSS/JS/图片/字体/音频/JSON），注入 404/500/超时
- E2E：真实 H5 页面，验证列表、筛选、暂停/继续/停止、导出结构与进度

## 13. 分阶段里程碑
- 阶段 A：脚手架与布局（1080×1380 窗口；720×100/720×1280/右栏 360 框架）
- 阶段 B：导航与会话管理（partition、计时器、状态机，无捕获）
- 阶段 C：元信息捕获（webRequest 基础元数据，列表/统计联动）
- 阶段 D：内容拦截与落盘（interceptStreamProtocol 实时写盘、并发/重试）
- 阶段 E：导出实现（external/<host>/...、查询短哈希、进度）
- 阶段 F：筛选/搜索/排序与失败重试（react-window 优化）
- 阶段 G：稳定性与性能（节流、恢复、清理策略、设置项完善）
- 阶段 H：打包与发布（配置、图标、README）

## 14. 验收与交付
- 每阶段通过：功能可用性、性能阈值、错误处理覆盖、UI 交互一致性
- 交付物：源码、配置与脚本、可运行包、使用说明与已知限制


